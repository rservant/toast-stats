# Requirements Document

## Introduction

The `GET /api/districts/:districtId/analytics-summary` endpoint currently returns a 404 because it reads summary data from `PreComputedAnalyticsService`, which depends on an `analytics-summary.json` file that is never generated by the collector-cli. The per-district analytics files (e.g., `district_42_analytics.json`) already contain all the necessary data and are already used by the same route for year-over-year and distinguished projection data via `PreComputedAnalyticsReader`. This feature rewires the summary data source to use `PreComputedAnalyticsReader.readDistrictAnalytics()` instead of `PreComputedAnalyticsService.getLatestSummary()`, eliminating the dependency on the missing file.

## Glossary

- **Analytics_Summary_Route**: The Express route handler at `GET /api/districts/:districtId/analytics-summary` that returns aggregated analytics data
- **PreComputedAnalyticsReader**: The service that reads per-district analytics files from the `analytics/` subdirectory within snapshot directories (e.g., `district_42_analytics.json`)
- **PreComputedAnalyticsService**: The legacy service that reads the `analytics-summary.json` file from snapshot directories — this file is never generated
- **DistrictAnalytics**: The data type returned by `PreComputedAnalyticsReader.readDistrictAnalytics()`, containing `totalMembership`, `membershipChange`, club arrays, `distinguishedClubs`, and `distinguishedProjection`
- **AggregatedAnalyticsResponse**: The response type returned by the Analytics_Summary_Route, containing summary metrics, trend data, year-over-year comparison, and metadata
- **Snapshot_Store**: The service that manages snapshot metadata and provides the latest successful snapshot ID
- **Latest_Successful_Snapshot**: The most recent snapshot that completed successfully, used as the data source for summary metrics; the `startDate`/`endDate` query parameters do not affect which snapshot is used for summary data — they only filter trend data from the time-series index

## Requirements

### Requirement 1: Read summary data from per-district analytics files

**User Story:** As a frontend consumer, I want the analytics-summary endpoint to return valid summary data, so that the dashboard displays district analytics without falling back to individual endpoint calls.

#### Acceptance Criteria

1. WHEN the Analytics_Summary_Route receives a request for a district, THE Analytics_Summary_Route SHALL obtain the latest successful snapshot ID from the Snapshot_Store and read summary data from `PreComputedAnalyticsReader.readDistrictAnalytics()` using that snapshot ID
2. THE Analytics_Summary_Route SHALL NOT depend on `PreComputedAnalyticsService` or the `analytics-summary.json` file for summary data
3. WHEN `PreComputedAnalyticsReader.readDistrictAnalytics()` returns a valid DistrictAnalytics object, THE Analytics_Summary_Route SHALL map `totalMembership`, `membershipChange`, club count fields, `distinguishedClubs`, and `distinguishedProjection` into the AggregatedAnalyticsResponse summary section
4. WHEN `PreComputedAnalyticsReader.readDistrictAnalytics()` returns null, THE Analytics_Summary_Route SHALL return HTTP 404 with error code `ANALYTICS_NOT_AVAILABLE`
5. WHEN no successful snapshot exists in the Snapshot_Store, THE Analytics_Summary_Route SHALL return HTTP 404 with error code `ANALYTICS_NOT_AVAILABLE`

### Requirement 2: Derive club counts from club arrays

**User Story:** As a frontend consumer, I want accurate club health counts in the summary, so that the dashboard correctly displays thriving, vulnerable, and intervention-required club totals.

#### Acceptance Criteria

1. WHEN building the summary response, THE Analytics_Summary_Route SHALL derive `clubCounts.total` from the length of the `allClubs` array in the DistrictAnalytics object
2. WHEN building the summary response, THE Analytics_Summary_Route SHALL derive `clubCounts.thriving` from the length of the `thrivingClubs` array in the DistrictAnalytics object
3. WHEN building the summary response, THE Analytics_Summary_Route SHALL derive `clubCounts.vulnerable` from the length of the `vulnerableClubs` array in the DistrictAnalytics object
4. WHEN building the summary response, THE Analytics_Summary_Route SHALL derive `clubCounts.interventionRequired` from the length of the `interventionRequiredClubs` array in the DistrictAnalytics object

### Requirement 3: Consolidate PreComputedAnalyticsReader usage

**User Story:** As a developer, I want the route to use a single `readDistrictAnalytics()` call for all per-district data, so that the code is simpler and avoids redundant file reads.

#### Acceptance Criteria

1. THE Analytics_Summary_Route SHALL use a single call to `PreComputedAnalyticsReader.readDistrictAnalytics()` to obtain summary data, distinguished projection data, and any other per-district analytics data
2. THE Analytics_Summary_Route SHALL NOT make separate calls to `readDistrictAnalytics()` for distinguished projection data
3. WHEN the single `readDistrictAnalytics()` call succeeds, THE Analytics_Summary_Route SHALL extract `distinguishedProjection.projectedDistinguished` from the returned DistrictAnalytics object

### Requirement 4: Remove unused PreComputedAnalyticsService import

**User Story:** As a developer, I want dead code removed from the route, so that the codebase stays clean and the dependency on the missing `analytics-summary.json` file is fully eliminated.

#### Acceptance Criteria

1. THE Analytics_Summary_Route SHALL NOT import or call `getPreComputedAnalyticsService` from the shared module
2. IF `getPreComputedAnalyticsService` has no remaining consumers in route files, THEN the shared module SHOULD remove the export

### Requirement 5: Maintain response contract and OpenAPI synchronization

**User Story:** As a frontend consumer, I want the response shape to remain unchanged, so that existing dashboard components continue to work without modification.

#### Acceptance Criteria

1. THE Analytics_Summary_Route SHALL return the same AggregatedAnalyticsResponse shape with identical field names and types as the current implementation
2. THE Analytics_Summary_Route SHALL set `dataSource` to `"precomputed"` in the response
3. THE `backend/openapi.yaml` specification for the analytics-summary endpoint SHALL remain synchronized with the implementation after changes
4. THE Analytics_Summary_Route SHALL continue to support `startDate` and `endDate` query parameters for trend data filtering

### Requirement 6: Update existing tests

**User Story:** As a developer, I want the route tests to reflect the new data source, so that tests validate the correct behavior and do not mock the removed service.

#### Acceptance Criteria

1. WHEN updating tests for the Analytics_Summary_Route, THE test suite SHALL mock `PreComputedAnalyticsReader.readDistrictAnalytics()` instead of `PreComputedAnalyticsService.getLatestSummary()`
2. WHEN `readDistrictAnalytics()` returns null in tests, THE test suite SHALL verify the route returns HTTP 404 with error code `ANALYTICS_NOT_AVAILABLE`
3. WHEN `readDistrictAnalytics()` returns a valid DistrictAnalytics object in tests, THE test suite SHALL verify the response contains correctly mapped summary fields including club counts derived from array lengths
