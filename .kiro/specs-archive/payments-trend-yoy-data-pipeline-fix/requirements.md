# Requirements Document

## Introduction

This spec addresses two persistent bugs in the Toastmasters dashboard where the data pipeline produces incorrect results for the Membership Payments Trend chart and the Year-Over-Year Comparison section. Previous fix attempts targeted the wrong layers. The root causes are now identified: Bug 1 is in the backend `/analytics` endpoint reading payments trend from a single snapshot instead of the time-series index, and Bug 2 is in the `findSnapshotForDate` method in analytics-core returning the wrong snapshot when no previous year data exists.

## Glossary

- **Analytics_Endpoint**: The `GET /api/districts/:districtId/analytics` route in the backend that serves pre-computed district analytics
- **Time_Series_Index_Service**: The read-only backend service (`TimeSeriesIndexService`) that reads pre-computed time-series data from index files partitioned by program year
- **Payments_Trend**: An array of `{ date, payments }` data points representing membership payment counts over time, displayed as a line chart
- **findSnapshotForDate**: A private method in `AnalyticsComputer` that locates the snapshot closest to a target date from an array of district snapshots
- **computeYearOverYear**: A method in `AnalyticsComputer` that computes year-over-year comparison metrics by comparing current and previous year snapshots
- **YearOverYearComparison_Component**: The React frontend component (`YearOverYearComparison.tsx`) that displays year-over-year metric comparisons
- **Pre_Computed_Analytics**: Analytics files generated by scraper-cli and stored on disk, read by the backend without any computation
- **Program_Year**: The Toastmasters fiscal year running from July 1 to June 30

## Requirements

### Requirement 1: Payments Trend Uses Time-Series Index

**User Story:** As a district leader, I want the Membership Payments Trend chart to show a full line of monthly data points across multiple years, so that I can observe payment trends over time.

#### Acceptance Criteria

1. WHEN the Analytics_Endpoint receives a request with `startDate` and `endDate` query parameters, THE Analytics_Endpoint SHALL retrieve Payments_Trend data from the Time_Series_Index_Service using those date parameters instead of reading from a single snapshot's pre-computed membership analytics file
2. WHEN the Time_Series_Index_Service returns data points for the requested date range, THE Analytics_Endpoint SHALL map each data point to a `{ date, payments }` object and include the resulting array as `paymentsTrend` in the response
3. WHEN the Time_Series_Index_Service returns an empty array or throws an error, THE Analytics_Endpoint SHALL omit `paymentsTrend` from the response and log a debug-level message
4. WHEN no `startDate` or `endDate` query parameters are provided, THE Analytics_Endpoint SHALL omit `paymentsTrend` from the response rather than falling back to the single-snapshot membership analytics file

### Requirement 2: findSnapshotForDate Enforces Date Proximity

**User Story:** As a district leader, I want the Year-Over-Year Comparison to show accurate previous year data or clearly indicate when historical data is unavailable, so that I am not misled by identical current/previous values.

#### Acceptance Criteria

1. THE findSnapshotForDate method SHALL return `undefined` when the closest available snapshot is more than 180 days from the target date
2. WHEN findSnapshotForDate returns `undefined` for the previous year date, THE computeYearOverYear method SHALL return `dataAvailable: false` with an explanatory message
3. WHEN findSnapshotForDate finds an exact date match, THE findSnapshotForDate method SHALL return that snapshot regardless of any proximity threshold

### Requirement 3: YearOverYearComparison Component Handles Zero-Change Data

**User Story:** As a district leader, I want the Year-Over-Year Comparison section to show a "No Historical Data" empty state when all percentage changes are zero, so that I am not shown misleading identical values for previous and current year.

#### Acceptance Criteria

1. WHEN the YearOverYearComparison_Component receives `yearOverYear` data where `membershipChange`, `distinguishedChange`, and `clubHealthChange` are all exactly zero, THE YearOverYearComparison_Component SHALL render the "No Historical Data" empty state instead of displaying comparison cards with identical values
2. WHEN the YearOverYearComparison_Component receives `yearOverYear` data where at least one change value is non-zero, THE YearOverYearComparison_Component SHALL render the full comparison view with cards and charts

### Requirement 4: Pre-Computed YoY Data Reflects Fix

**User Story:** As a system operator, I want the scraper-cli `compute-analytics` command to produce correct year-over-year data after the `findSnapshotForDate` fix, so that the backend serves accurate pre-computed YoY comparisons.

#### Acceptance Criteria

1. WHEN the scraper-cli `compute-analytics` command runs and no previous year snapshot exists on disk for a district, THE command SHALL produce a pre-computed analytics file with `yearOverYear.dataAvailable` set to `false`
2. WHEN the scraper-cli `compute-analytics` command runs and a valid previous year snapshot exists on disk for a district, THE command SHALL produce a pre-computed analytics file with `yearOverYear.dataAvailable` set to `true` and accurate comparison metrics
