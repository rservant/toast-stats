name: TypeScript Zero Error Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'

jobs:
  typescript-check:
    name: TypeScript Compilation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check Backend TypeScript Compilation
      id: backend-ts
      run: |
        echo "Checking backend TypeScript compilation..."
        ERROR_COUNT=$(npm run typecheck:backend 2>&1 | grep -E "error TS[0-9]+" | wc -l || echo "0")
        echo "Backend TypeScript errors: $ERROR_COUNT"
        echo "backend_errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "âŒ Backend has $ERROR_COUNT TypeScript errors"
          echo "Detailed errors:"
          npm run typecheck:backend 2>&1 | grep -E "error TS[0-9]+" | head -20
          exit 1
        else
          echo "âœ… Backend TypeScript compilation successful"
        fi
    
    - name: Check Frontend TypeScript Compilation
      id: frontend-ts
      run: |
        echo "Checking frontend TypeScript compilation..."
        ERROR_COUNT=$(npm run typecheck:frontend 2>&1 | grep -E "error TS[0-9]+" | wc -l || echo "0")
        echo "Frontend TypeScript errors: $ERROR_COUNT"
        echo "frontend_errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
        
        if [ "$ERROR_COUNT" -gt 0 ]; then
          echo "âŒ Frontend has $ERROR_COUNT TypeScript errors"
          echo "Detailed errors:"
          npm run typecheck:frontend 2>&1 | grep -E "error TS[0-9]+" | head -20
          exit 1
        else
          echo "âœ… Frontend TypeScript compilation successful"
        fi
    
    - name: TypeScript Summary
      if: always()
      run: |
        BACKEND_ERRORS="${{ steps.backend-ts.outputs.backend_errors }}"
        FRONTEND_ERRORS="${{ steps.frontend-ts.outputs.frontend_errors }}"
        TOTAL_ERRORS=$((BACKEND_ERRORS + FRONTEND_ERRORS))
        
        echo "## TypeScript Compilation Results" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Error Count | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend | $BACKEND_ERRORS | $([ $BACKEND_ERRORS -eq 0 ] && echo 'âœ… Pass' || echo 'âŒ Fail') |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | $FRONTEND_ERRORS | $([ $FRONTEND_ERRORS -eq 0 ] && echo 'âœ… Pass' || echo 'âŒ Fail') |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total** | **$TOTAL_ERRORS** | $([ $TOTAL_ERRORS -eq 0 ] && echo 'âœ… **PASS**' || echo 'âŒ **FAIL**') |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TOTAL_ERRORS" -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **POLICY VIOLATION**: TypeScript errors are not permitted in this repository." >> $GITHUB_STEP_SUMMARY
          echo "Please fix all TypeScript errors before merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the [TypeScript Policy](.kiro/steering/typescript-policy.md) for details." >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **SUCCESS**: Zero TypeScript errors detected. Policy compliance achieved!" >> $GITHUB_STEP_SUMMARY
        fi

  lint-and-format:
    name: Linting and Code Quality
    runs-on: ubuntu-latest
    needs: typescript-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Lint code
      run: npm run lint
    
    - name: Check code formatting
      run: |
        npm run format
        if [ -n "$(git status --porcelain)" ]; then
          echo "âŒ Code formatting issues detected"
          echo "Please run 'npm run format' and commit the changes"
          git diff
          exit 1
        else
          echo "âœ… Code formatting is correct"
        fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: typescript-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: |
        echo "Running backend tests..."
        npm run test:backend
        echo "Running frontend tests..."
        npm run test:frontend

  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: [typescript-check, lint-and-format, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build applications
      run: |
        echo "Building backend..."
        npm run build:backend
        echo "Building frontend..."
        npm run build:frontend
    
    - name: Build success summary
      run: |
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Backend build completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Frontend build completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All TypeScript compilation checks passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY