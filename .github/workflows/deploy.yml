# Production Deployment Workflow
# Deploys backend to Cloud Run and frontend to Firebase Hosting
# on every merge to main, after CI passes.
#
# Prerequisites:
#   1. Run scripts/setup-wif.sh (one-time)
#   2. Add GitHub secrets: GCP_PROJECT_ID, GCP_WORKLOAD_IDENTITY_PROVIDER, GCP_SERVICE_ACCOUNT

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  REGION: 'us-east1'
  CLOUD_RUN_SERVICE: 'toast-stats-api'
  GCS_BUCKET: 'toast-stats-data'

permissions:
  contents: read
  id-token: write # Required for Workload Identity Federation
  packages: write # Required by CI workflow
  pull-requests: write # Required by CI workflow
  security-events: write # Required by CI workflow

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate: CI must pass before deployment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Quality Gates
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Backend to Cloud Run
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --source=. \
            --region=${{ env.REGION }} \
            --platform=managed \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="STORAGE_PROVIDER=gcp" \
            --set-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars="GCS_BUCKET_NAME=${{ env.GCS_BUCKET }}" \
            --set-env-vars="CORS_ORIGIN=https://ts.taverns.red" \
            --set-secrets="JWT_SECRET=jwt-secret:latest" \
            --no-allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --quiet

      - name: Grant Firebase Hosting access to Cloud Run
        run: |
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format='value(projectNumber)')
          echo "Project number: ${PROJECT_NUMBER}"

          echo "## Available Service Accounts (firebase/hosting related):" >> "$GITHUB_STEP_SUMMARY"
          gcloud iam service-accounts list --format='table(email)' \
            --filter='email:firebase OR email:hosting OR email:compute' \
            | tee -a "$GITHUB_STEP_SUMMARY"

          echo ""
          echo "Attempting IAM binding with ${PROJECT_NUMBER}-compute@developer.gserviceaccount.com..."
          gcloud run services add-iam-policy-binding ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.REGION }} \
            --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
            --role="roles/run.invoker" \
            --quiet

      - name: Get deployment URL
        id: deploy-url
        run: |
          URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "## Backend Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Deployed to: ${URL}" >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Frontend to Firebase Hosting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build dependency packages
        run: |
          npm run build:shared-contracts
          npm run build:analytics-core

      - name: Build frontend
        run: npm run build:frontend

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting --project ${{ secrets.GCP_PROJECT_ID }}


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Post-Deployment Verification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deploy-verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]

    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Health check
        run: |
          echo "## Post-Deployment Verification" >> "$GITHUB_STEP_SUMMARY"

          # Check backend health via Firebase Hosting rewrite
          HOSTING_URL="https://${{ secrets.GCP_PROJECT_ID }}.web.app"

          echo "Checking health at ${HOSTING_URL}/api/health..."
          RESPONSE=$(curl -sf --max-time 30 "${HOSTING_URL}/api/health" || true)

          if echo "${RESPONSE}" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ Health check returned unexpected response" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE:-'(no response)'}" >> "$GITHUB_STEP_SUMMARY"
            echo "::warning::Health check did not return expected response. Manual verification recommended."
          fi

      - name: Deployment summary
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸš€ Deployment complete for commit \`${GITHUB_SHA::7}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Frontend**: https://${{ secrets.GCP_PROJECT_ID }}.web.app" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Triggered by**: @${GITHUB_ACTOR}" >> "$GITHUB_STEP_SUMMARY"
