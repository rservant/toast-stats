# Production Deployment Workflow
# Deploys backend to Cloud Run and frontend to Firebase Hosting
# on every merge to main, after CI passes.
#
# Prerequisites:
#   1. Run scripts/setup-wif.sh (one-time)
#   2. Add GitHub secrets: GCP_PROJECT_ID, GCP_WORKLOAD_IDENTITY_PROVIDER, GCP_SERVICE_ACCOUNT

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  REGION: 'us-east1'
  CLOUD_RUN_SERVICE: 'toast-stats-api'
  GCS_BUCKET: 'toast-stats-data'

permissions:
  contents: read
  id-token: write # Required for Workload Identity Federation
  packages: write # Required by CI workflow
  pull-requests: write # Required by CI workflow
  security-events: write # Required by CI workflow

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate: CI must pass before deployment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Quality Gates
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Backend to Cloud Run
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --source=. \
            --region=${{ env.REGION }} \
            --platform=managed \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="STORAGE_PROVIDER=gcp" \
            --set-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars="GCS_BUCKET_NAME=${{ env.GCS_BUCKET }}" \
            --set-env-vars="CORS_ORIGIN=https://${{ secrets.GCP_PROJECT_ID }}.web.app" \
            --set-secrets="JWT_SECRET=jwt-secret:latest" \
            --no-allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --quiet

      - name: Get deployment URL
        id: deploy-url
        run: |
          URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "## Backend Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Deployed to: ${URL}" >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Frontend to Firebase Hosting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build dependency packages
        run: |
          npm run build:shared-contracts
          npm run build:analytics-core

      - name: Build frontend
        run: npm run build:frontend

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting --project ${{ secrets.GCP_PROJECT_ID }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy API Gateway (only when openapi.yaml changes)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-api-gateway:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    needs: [deploy-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need previous commit to detect changes

      - name: Check if openapi.yaml changed
        id: check-changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q 'backend/openapi.yaml'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "openapi.yaml has changed â€” will deploy API Gateway config"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "openapi.yaml unchanged â€” skipping API Gateway deployment"
          fi

      - name: Authenticate to GCP
        if: steps.check-changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        if: steps.check-changes.outputs.changed == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy API Gateway config
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          CONFIG_NAME="toast-stats-config-$(date +%Y%m%d%H%M%S)"

          echo "Creating API config: ${CONFIG_NAME}..."
          gcloud api-gateway api-configs create "${CONFIG_NAME}" \
            --api=toast-stats-api \
            --openapi-spec=backend/openapi.yaml \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet

          echo "Updating gateway to use ${CONFIG_NAME}..."
          gcloud api-gateway gateways update toast-stats-gateway \
            --api=toast-stats-api \
            --api-config="${CONFIG_NAME}" \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet

          echo "## API Gateway Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Deployed config: \`${CONFIG_NAME}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Skip summary
        if: steps.check-changes.outputs.changed != 'true'
        run: |
          echo "## API Gateway Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "â­ï¸ Skipped â€” no changes to openapi.yaml" >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Post-Deployment Verification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deploy-verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, deploy-api-gateway]

    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Health check
        run: |
          echo "## Post-Deployment Verification" >> "$GITHUB_STEP_SUMMARY"

          # Check backend health via Firebase Hosting rewrite
          HOSTING_URL="https://${{ secrets.GCP_PROJECT_ID }}.web.app"

          echo "Checking health at ${HOSTING_URL}/api/health..."
          RESPONSE=$(curl -sf --max-time 30 "${HOSTING_URL}/api/health" || true)

          if echo "${RESPONSE}" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ Health check returned unexpected response" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE:-'(no response)'}" >> "$GITHUB_STEP_SUMMARY"
            echo "::warning::Health check did not return expected response. Manual verification recommended."
          fi

      - name: Deployment summary
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸš€ Deployment complete for commit \`${GITHUB_SHA::7}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Frontend**: https://${{ secrets.GCP_PROJECT_ID }}.web.app" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Triggered by**: @${GITHUB_ACTOR}" >> "$GITHUB_STEP_SUMMARY"
