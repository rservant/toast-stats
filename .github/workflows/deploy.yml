# Production Deployment Workflow
# Deploys backend to Cloud Run and frontend to Firebase Hosting
# on every merge to main, after CI passes.
#
# Prerequisites:
#   1. Run scripts/setup-wif.sh (one-time)
#   2. Add GitHub secrets: GCP_PROJECT_ID, GCP_WORKLOAD_IDENTITY_PROVIDER, GCP_SERVICE_ACCOUNT

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  REGION: 'us-east1'
  CLOUD_RUN_SERVICE: 'toast-stats-api'
  GCS_BUCKET: 'toast-stats-data'

permissions:
  contents: write # Required to push version tags
  id-token: write # Required for Workload Identity Federation
  packages: write # Required by CI workflow
  pull-requests: write # Required by CI workflow
  security-events: write # Required by CI workflow

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate: CI must pass before deployment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: CI Quality Gates
    uses: ./.github/workflows/ci.yml

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Compute Semantic Version from Conventional Commits
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  version:
    name: Compute Version
    runs-on: ubuntu-latest
    needs: ci
    outputs:
      version: ${{ steps.semver.outputs.version }}
      tag: ${{ steps.semver.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for tag lookup

      - name: Compute semantic version
        id: semver
        run: |
          # Find latest version tag (or default to v0.0.0)
          LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
            echo "No existing tags found, starting from v0.0.0"
          else
            echo "Latest tag: $LATEST_TAG"
          fi

          # Parse current version
          CURRENT=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Scan commits since last tag for conventional commit prefixes
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:'%s' HEAD)
          else
            COMMITS=$(git log --pretty=format:'%s' "${LATEST_TAG}..HEAD")
          fi

          # Determine bump type
          BUMP="patch"
          if echo "$COMMITS" | grep -qiE '^feat[!(:]'; then
            BUMP="minor"
          fi
          if echo "$COMMITS" | grep -qiE 'BREAKING CHANGE'; then
            BUMP="major"
          fi

          # Apply bump
          case $BUMP in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          NEW_TAG="v${NEW_VERSION}"

          echo "Bump type: $BUMP"
          echo "New version: $NEW_VERSION (tag: $NEW_TAG)"
          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${NEW_TAG}" >> "$GITHUB_OUTPUT"

          echo "## Version" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ“¦ **${NEW_TAG}** (${BUMP} bump from ${LATEST_TAG})" >> "$GITHUB_STEP_SUMMARY"

      - name: Create and push tag
        run: |
          TAG="${{ steps.semver.outputs.tag }}"
          # Only create tag if it doesn't already exist
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping"
          else
            git tag "$TAG"
            git push origin "$TAG"
            echo "Created and pushed tag: $TAG"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Backend to Cloud Run
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --source=. \
            --region=${{ env.REGION }} \
            --platform=managed \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="STORAGE_PROVIDER=gcp" \
            --set-env-vars="GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars="GCS_BUCKET_NAME=${{ env.GCS_BUCKET }}" \
            --set-env-vars="CORS_ORIGIN=https://ts.taverns.red" \
            --set-secrets="JWT_SECRET=jwt-secret:latest" \
            --no-allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --quiet

      - name: Get deployment URL
        id: deploy-url
        run: |
          URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "## Backend Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Deployed to: ${URL}" >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy Frontend to Firebase Hosting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [ci, version]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build dependency packages
        run: |
          npm run build:shared-contracts
          npm run build:analytics-core

      - name: Build frontend
        run: npm run build:frontend
        env:
          VITE_APP_VERSION: v${{ needs.version.outputs.version }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting --project ${{ secrets.GCP_PROJECT_ID }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy API Gateway (only when openapi.yaml changes)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-api-gateway:
    name: Deploy API Gateway
    runs-on: ubuntu-latest
    needs: [deploy-backend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history to diff across all pushed commits

      - name: Check if openapi.yaml changed
        id: check-changes
        run: |
          # Use the before SHA from the push event to diff all commits in this push.
          # For workflow_dispatch (no before SHA), fall back to HEAD~1.
          BEFORE_SHA="${{ github.event.before }}"
          if [ -z "$BEFORE_SHA" ] || [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BEFORE_SHA="HEAD~1"
          fi

          echo "Diffing ${BEFORE_SHA}..HEAD for openapi.yaml changes"
          if git diff --name-only "${BEFORE_SHA}" HEAD | grep -q 'backend/openapi.yaml'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "openapi.yaml has changed â€” will deploy API Gateway config"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "openapi.yaml unchanged â€” skipping API Gateway deployment"
          fi

      - name: Authenticate to GCP
        if: steps.check-changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        if: steps.check-changes.outputs.changed == 'true'
        uses: google-github-actions/setup-gcloud@v3

      - name: Deploy API Gateway config
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          CONFIG_NAME="toast-stats-config-$(date +%Y%m%d%H%M%S)"

          echo "Creating API config: ${CONFIG_NAME}..."
          gcloud api-gateway api-configs create "${CONFIG_NAME}" \
            --api=toast-stats \
            --openapi-spec=backend/openapi.yaml \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet

          echo "Updating gateway to use ${CONFIG_NAME}..."
          gcloud api-gateway gateways update toast-stats-gw \
            --api=toast-stats \
            --api-config="${CONFIG_NAME}" \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet

          echo "## API Gateway Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "âœ… Deployed config: \`${CONFIG_NAME}\`" >> "$GITHUB_STEP_SUMMARY"

      - name: Skip summary
        if: steps.check-changes.outputs.changed != 'true'
        run: |
          echo "## API Gateway Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "â­ï¸ Skipped â€” no changes to openapi.yaml" >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Post-Deployment Verification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-deploy-verify:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, deploy-api-gateway]

    steps:
      - name: Wait for services to stabilize
        run: sleep 30

      - name: Health check
        run: |
          echo "## Post-Deployment Verification" >> "$GITHUB_STEP_SUMMARY"

          # Check backend health via API Gateway
          GW_URL="https://toast-stats-gw-9e9mo5c1.ue.gateway.dev"

          echo "Checking health at ${GW_URL}/api/health..."
          RESPONSE=$(curl -sf --max-time 30 "${GW_URL}/api/health" || true)

          if echo "${RESPONSE}" | grep -q '"status":"ok"'; then
            echo "âœ… Health check passed" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âš ï¸ Health check returned unexpected response" >> "$GITHUB_STEP_SUMMARY"
            echo "Response: ${RESPONSE:-'(no response)'}" >> "$GITHUB_STEP_SUMMARY"
            echo "::warning::Health check did not return expected response. Manual verification recommended."
          fi

      - name: Deployment summary
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸš€ Deployment complete for commit \`${GITHUB_SHA::7}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Frontend**: https://${{ secrets.GCP_PROJECT_ID }}.web.app" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Triggered by**: @${GITHUB_ACTOR}" >> "$GITHUB_STEP_SUMMARY"
