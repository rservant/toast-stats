# Backend Services Documentation

## Overview

The backend services implement a modular, dependency-injected architecture with clear separation of concerns. The system now supports serving pre-computed analytics from files generated by the scraper-cli pipeline.

## Service Architecture

### Core Services

#### RefreshService

**Purpose**: Orchestrates the complete data refresh workflow

**Extracted Modules**:

- `ClosingPeriodDetector` (234 lines): Month-end closing period detection
- `DataNormalizer` (364 lines): Raw data transformation to normalized format

**Responsibilities**:

- Coordinate snapshot creation from cached CSV data
- Implement retry logic with exponential backoff
- Four-phase workflow: cache check → normalization → validation → snapshot creation

#### AnalyticsEngine

**Purpose**: Orchestrates analytics processing by delegating to specialized modules

**Extracted Modules** (in `analytics/` directory):

- `MembershipAnalyticsModule` (635 lines): Membership trends and year-over-year analysis
- `DistinguishedClubAnalyticsModule` (814 lines): Distinguished club tracking and projections
- `ClubHealthAnalyticsModule` (699 lines): At-risk club identification and health scoring
- `DivisionAreaAnalyticsModule` (448 lines): Division comparisons and area analysis
- `LeadershipAnalyticsModule` (665 lines): Leadership effectiveness analysis
- `AnalyticsUtils` (245 lines): Shared utility functions

#### PreComputedAnalyticsReader

**Purpose**: Reads and serves pre-computed analytics files generated by scraper-cli

**Location**: `backend/src/services/PreComputedAnalyticsReader.ts`

**Responsibilities**:

- Read pre-computed analytics from `CACHE_DIR/snapshots/{date}/analytics/`
- Validate schema version compatibility
- Return appropriate HTTP errors (404 for missing, 500 for incompatible)
- Log analytics serving operations

**Key Methods**:

```typescript
interface IPreComputedAnalyticsReader {
  readDistrictAnalytics(
    snapshotDate: string,
    districtId: string
  ): Promise<DistrictAnalytics>
  checkAnalyticsAvailability(
    snapshotDate: string,
    districtId: string
  ): Promise<boolean>
}
```

**Error Handling**:

| Scenario                    | HTTP Status | Error Code                |
| --------------------------- | ----------- | ------------------------- |
| Analytics file not found    | 404         | `ANALYTICS_NOT_FOUND`     |
| Invalid JSON                | 500         | `ANALYTICS_CORRUPTED`     |
| Incompatible schema version | 500         | `SCHEMA_VERSION_MISMATCH` |

#### PreComputedAnalyticsService

**Purpose**: Higher-level service that coordinates analytics serving

**Location**: `backend/src/services/PreComputedAnalyticsService.ts`

**Responsibilities**:

- Determine which snapshot date to use for analytics
- Coordinate with PreComputedAnalyticsReader
- Handle fallback logic when exact date not available

#### RawCSVCacheService

**Purpose**: Caches raw CSV data from Toastmasters dashboard

**Extracted Modules**:

- `CacheSecurityManager` (281 lines): Path validation and security checks
- `CacheIntegrityValidator` (444 lines): Metadata validation and corruption detection

### Storage Services

- `FileSnapshotStore`: Legacy single-file snapshot storage
- `PerDistrictSnapshotStore`: Modern per-district directory-based storage
- `DistrictDataAggregator`: Efficient per-district data access with caching

### Infrastructure Services

- `ServiceContainer`: Dependency injection container
- `ProductionServiceFactory`: Production service instantiation
- `TestServiceFactory`: Test service instantiation with mock support

## Pre-Computed Analytics Pipeline

The backend now supports serving pre-computed analytics generated by the scraper-cli:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Pre-Computed Analytics Flow                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  scraper-cli                                                         │
│  ┌──────────┐    ┌───────────┐    ┌─────────────────┐               │
│  │  scrape  │───▶│ transform │───▶│ compute-analytics│               │
│  └──────────┘    └───────────┘    └─────────────────┘               │
│                                            │                         │
│                                            ▼                         │
│                              CACHE_DIR/snapshots/{date}/analytics/   │
│                                            │                         │
├────────────────────────────────────────────┼─────────────────────────┤
│  backend                                   │                         │
│                                            ▼                         │
│                              ┌─────────────────────────┐             │
│                              │ PreComputedAnalyticsReader│            │
│                              └─────────────────────────┘             │
│                                            │                         │
│                                            ▼                         │
│                              ┌─────────────────────────┐             │
│                              │   API Response          │             │
│                              │ /api/districts/:id/analytics          │
│                              └─────────────────────────┘             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Analytics File Structure

```
CACHE_DIR/snapshots/{date}/analytics/
├── manifest.json                    # List of files with checksums
├── district_42_analytics.json       # District 42 analytics
├── district_57_analytics.json       # District 57 analytics
└── ...
```

### Analytics File Format

Each analytics file follows the `PreComputedAnalyticsFile<T>` structure:

```typescript
{
  "schemaVersion": "1.0.0",
  "computedAt": "2025-01-10T12:00:00.000Z",
  "checksum": "sha256:abc123...",
  "data": {
    "membershipTrends": { ... },
    "clubHealth": { ... },
    "distinguishedClubs": { ... },
    "divisionAreaAnalytics": { ... }
  }
}
```

## Cache Service

The CacheService provides in-memory caching using `node-cache`:

### Features

- 15-minute default TTL
- Custom TTL per entry
- Cache bypass support
- Automatic cleanup
- Express middleware integration

### Usage

```typescript
import { cacheService } from '../services/CacheService.js'

// Set a value
cacheService.set('my-key', { data: 'value' })

// Get a value
const data = cacheService.get('my-key')

// Invalidate
cacheService.invalidate('my-key')
```

### Cache Middleware

```typescript
import { cacheMiddleware } from '../middleware/cache.js'

router.get('/data', cacheMiddleware({ ttl: 300 }), async (req, res) => {
  const data = await fetchData()
  res.json(data)
})
```

### Cache Bypass

```bash
# Query parameter
GET /api/districts?refresh=true

# Header
GET /api/districts
X-Bypass-Cache: true
```

## Testing

All services have comprehensive test coverage:

- Unit tests for core logic
- Integration tests for workflows
- Property-based tests for correctness properties

Run tests:

```bash
npm test
```

### PreComputedAnalyticsReader Tests

The PreComputedAnalyticsReader has dedicated tests covering:

- Valid analytics file reading
- 404 for missing files
- 500 for corrupted JSON
- 500 for incompatible schema version
- Multiple district handling
- Input validation

## Architecture Decisions

1. **Modular Extraction**: Large services (>1000 lines) are split into focused modules
2. **Dependency Injection**: Services use constructor injection for testability
3. **Interface-Based Design**: Services implement interfaces for mock support
4. **Property-Based Testing**: Universal correctness properties validated with fast-check
5. **Pre-Computed Analytics**: Analytics computed offline by scraper-cli, served by backend
6. **Schema Versioning**: Analytics files include version for compatibility checking
