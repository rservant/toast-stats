# Club Detail Card — Data Flow & Review

**Date:** February 16, 2026
**Component:** `frontend/src/components/ClubDetailModal.tsx`

---

## Data Flow Summary

1. User clicks a club row in `ClubsTable` → `onClubClick(club)` fires with a `ClubTrend` object already in memory (from the district analytics response)
2. `DistrictDetailPage` sets `selectedClub` state → passes it to `ClubDetailModal`
3. The `ClubTrend` data originates from the `/districts/:districtId/analytics` endpoint, which reads pre-computed files via `PreComputedAnalyticsReader`
4. Those files are generated by `scraper-cli` → `analytics-core` → `ClubHealthAnalyticsModule.analyzeClubTrends()` → written to `district_{id}_club-trends-index.json`

The modal does NOT make its own API call. It renders whatever `ClubTrend` object was passed from the table. There's a separate `useClubTrends` hook that fetches individual club data from `/districts/:districtId/clubs/:clubId/trends`, but the modal doesn't use it.

### Full Pipeline

```
Toastmasters Dashboard CSV
  → scraper-cli (Playwright scrape + CSV parse)
  → DataNormalizer → ClubStatistics
  → AnalyticsComputer → ClubHealthAnalyticsModule.analyzeClubTrends()
    → assessClubHealth() (health status classification)
    → identifyDistinguishedLevel() (distinguished level)
    → builds membershipTrend[] and dcpGoalsTrend[] from snapshots
  → Written to: snapshots/{date}/analytics/district_{id}_club-trends-index.json

Backend (read-only):
  GET /districts/:districtId/analytics
  → PreComputedAnalyticsReader.readDistrictAnalytics()
  → Returns allClubs[] containing ClubTrend objects

Frontend:
  useDistrictAnalytics() hook → fetches district analytics
  → ClubsTable renders rows from allClubs[]
  → Click → ClubDetailModal receives ClubTrend as prop
```

---

## Bugs Found

### 1. `distinguishedLevel` type mismatch between two frontend interfaces

**Severity:** Low (latent)
**Files:** `frontend/src/hooks/useDistrictAnalytics.ts`, `frontend/src/hooks/useClubTrends.ts`

`useDistrictAnalytics.ts` defines:

```ts
distinguishedLevel: 'NotDistinguished' |
  'Smedley' |
  'President' |
  'Select' |
  'Distinguished'
```

`useClubTrends.ts` defines:

```ts
distinguishedLevel?: 'President' | 'Select' | 'Distinguished'
```

The `useClubTrends` version is missing `'NotDistinguished'` and `'Smedley'`, and the field is optional. This means if the modal ever switches to use the `useClubTrends` hook, Smedley clubs would silently lose their distinguished badge. Not a live bug today since the modal uses the `useDistrictAnalytics` type, but it's a latent inconsistency that should be unified.

### 2. `'President'` vs `'Presidents'` naming inconsistency across modules

**Severity:** Medium
**Files:** `packages/analytics-core/src/analytics/ClubHealthAnalyticsModule.ts`, `packages/analytics-core/src/analytics/DistinguishedClubAnalyticsModule.ts`

`ClubHealthAnalyticsModule.determineDistinguishedLevel()` returns `'President'` (singular).
`DistinguishedClubAnalyticsModule.determineDistinguishedLevel()` returns `'Presidents'` (plural) and `'None'` instead of `'NotDistinguished'`.

The `analytics-core` canonical type `DistinguishedLevel` uses `'President'` (singular). So the `DistinguishedClubAnalyticsModule` is producing values that don't match the type. If any code path uses that module's output for club trend data, the distinguished badge would show "Presidents" instead of "President" or fail to match expected values.

### 3. SVG chart division-by-zero when only one data point

**Severity:** Medium
**File:** `frontend/src/components/ClubDetailModal.tsx`

When `membershipTrend` has exactly 1 point, the polyline calculation does:

```ts
const x = (index / (club.membershipTrend.length - 1)) * 800 // 0/0 = NaN
```

This produces `NaN` coordinates. The chart renders but the point placement is undefined. The `membershipRange` fallback (`|| 1`) handles the Y-axis case, but the X-axis division by zero is unguarded.

**Fix:** Guard with `Math.max(club.membershipTrend.length - 1, 1)` or render a single centered dot instead of a polyline when there's only one data point.

### 4. Membership payment data is available but not displayed

**Severity:** Low (missed opportunity)
**File:** `frontend/src/components/ClubDetailModal.tsx`

The `ClubTrend` object carries `octoberRenewals`, `aprilRenewals`, and `newMembers` fields (populated from the scraper pipeline), but the modal doesn't render them anywhere. This is data that's computed, stored, served, and transferred to the frontend — then silently dropped.

---

## Improvement Suggestions

### 5. DCP goals hardcoded to 10 max

The progress bar and labels use `{latestDcpGoals} / 10 goals` and `width: ${(latestDcpGoals / 10) * 100}%`. The Toastmasters DCP program does have 10 goals, so this is technically correct. But if the data ever includes a club with >10 (data anomaly), the bar overflows. A `Math.min(latestDcpGoals, 10)` cap would be safer for the width calculation.

### 6. Distinguished status display could be richer

The card shows "Distinguished" as a single badge. For Toastmasters context, the levels have meaningful hierarchy:

- Distinguished (5+ goals, 20+ members or net growth 3+)
- Select Distinguished (7+ goals, 20+ members or net growth 5+)
- President's Distinguished (9+ goals, 20+ members)
- Smedley Distinguished (10 goals, 25+ members)

The card could show the level name more descriptively (e.g., "President's Distinguished" instead of just "President") and potentially use different badge colors per tier to convey the achievement level at a glance.

### 7. No membership payment breakdown section

Given that October renewals, April renewals, and new members are key Toastmasters metrics for club health assessment, adding a small section showing these would give district leaders actionable insight. The data is already flowing through — it just needs a UI section.

### 8. The "Change" metric could be misleading

Membership change is calculated as `last point - first point` across the entire trend array. Depending on how many snapshots are in the array, this could span weeks or months. There's no label indicating the time period. A user might assume it's month-over-month when it's actually the full date range. Adding a label like "Change (since {startDate})" would clarify.

### 9. CSP status is always `true`

`ClubHealthAnalyticsModule.getCSPStatus()` returns `true` unconditionally with a comment saying the field doesn't exist yet in `ClubStatistics`. This means CSP never blocks a club from being classified as "thriving" or "distinguished." Once CSP data becomes available from the dashboard, this will need updating — but right now it's a known gap that inflates thriving/distinguished counts.

### 10. The modal doesn't use the dedicated `useClubTrends` hook

There's a purpose-built hook (`useClubTrends`) that fetches fresh per-club data from a dedicated endpoint (`/districts/:districtId/clubs/:clubId/trends`), but the modal just receives stale data from the parent's district analytics response. This means the modal shows whatever was last fetched at the district level, which could be up to 10 minutes stale (the `staleTime` on district analytics). For a detail view, fetching fresh data on open would be more accurate.

---

### 11. `useClubTrends.ts` is dead code

**Severity:** Low (cleanup)
**File:** `frontend/src/hooks/useClubTrends.ts`

Neither `useClubTrends` nor `useVulnerableClubs` (both exported from this file) are imported by any component in the codebase. The entire file is dead code. The hooks were presumably created for the club detail modal to fetch fresh per-club data, but the modal ended up taking the `ClubTrend` prop from the parent's district analytics response instead. The `useVulnerableClubs` hook is similarly orphaned — vulnerable clubs data comes through the district analytics response too.

This file also contains a divergent `ClubTrend` interface (see bug #1) which compounds the risk: if someone eventually imports from this file, they'll get a type that's missing `'NotDistinguished'` and `'Smedley'` from the distinguished level union.

**Recommendation:** Delete the file, or wire it into `ClubDetailModal` to fetch fresh data on open (which would also address improvement #10).

---

## Priority Ranking

| #   | Issue                                     | Type        | Severity | Effort  |
| --- | ----------------------------------------- | ----------- | -------- | ------- |
| 3   | SVG NaN on single data point              | Bug         | Medium   | Low     |
| 2   | President/Presidents naming inconsistency | Bug         | Medium   | Low     |
| 1   | distinguishedLevel type mismatch          | Bug         | Low      | Low     |
| 4   | Payment data not displayed                | Gap         | Low      | Medium  |
| 7   | Add payment breakdown section             | Enhancement | Low      | Medium  |
| 8   | Clarify "Change" time period              | Enhancement | Low      | Low     |
| 6   | Richer distinguished display              | Enhancement | Low      | Medium  |
| 5   | DCP goals overflow guard                  | Enhancement | Low      | Low     |
| 10  | Use useClubTrends hook                    | Enhancement | Low      | Medium  |
| 11  | useClubTrends.ts is dead code             | Cleanup     | Low      | Low     |
| 9   | CSP always true (known gap)               | Known Gap   | Low      | Blocked |
